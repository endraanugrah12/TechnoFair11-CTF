#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/fs.h>
#include <linux/uaccess.h>
#include <linux/slab.h>
#include <linux/mutex.h>

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Vaints");
MODULE_DESCRIPTION("kiss the rain, through the pain");
MODULE_VERSION("1.337");

#define DEVICE_NAME "serena"
#define KWRITE 0x13370001
#define KNOTHING 0x13370002
#define MAX_SIZE 0x400

static int majorNumber;
static struct mutex serena_mutex;

struct user_data {
    uint64_t target;
    uint64_t source;
};

long serena_nothing(unsigned long arg) {
    printk("serena: *bored*");
    return -EINVAL;
}

long serena_write(unsigned long arg) {
    struct user_data data;
    struct user_data __user *user_ptr = (struct user_data __user *)arg;
    long result = 0;

    if (copy_from_user(&data, user_ptr, sizeof(struct user_data))) {
        printk("serena: write failed");
        return -EFAULT;
    }
    mutex_lock(&serena_mutex);

    __asm__("autiza %0\n" : "=r"(data.target) : "r"(data.target));
    __asm__("autiza %0\n" : "=r"(data.source) : "r"(data.source));
    if (copy_from_user((void __user *)data.target, (void __user *)data.source, sizeof(uint64_t))) {
        printk("serena: copy_from_user failed");
        result = -EFAULT;
    } else {
        printk("serena: write success");
    }

    mutex_unlock(&serena_mutex);
    return result;
}

static long serena_ioctl(struct file *file, unsigned int cmd, unsigned long arg) {
    switch (cmd) {
        case KWRITE:
            return serena_write(arg);
        case KNOTHING:
            return serena_nothing(arg);
        default:
            return -EINVAL;
    }
}

static struct file_operations fops = {
    .unlocked_ioctl = serena_ioctl,
};

static int __init serena_init(void) {
    printk(KERN_INFO "serena: Initializing\n");

    mutex_init(&serena_mutex);

    majorNumber = register_chrdev(0, DEVICE_NAME, &fops);
    if (majorNumber < 0) {
        printk(KERN_ALERT "serena failed to register a major number %d\n", majorNumber);
        return majorNumber;
    }
    printk(KERN_INFO "serena: registered correctly with major number %d\n", majorNumber);

    return 0;
}

static void __exit serena_exit(void) {
    unregister_chrdev(majorNumber, DEVICE_NAME);
    mutex_destroy(&serena_mutex);
    printk(KERN_INFO "serena: Goodbye!\n");
}

module_init(serena_init);
module_exit(serena_exit);
